"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const testcafe_hammerhead_1 = require("testcafe-hammerhead");
const hook_1 = __importDefault(require("./hook"));
const parse_user_agent_1 = require("../../utils/parse-user-agent");
const test_run_tracker_1 = __importDefault(require("../test-run-tracker"));
const re_executable_promise_1 = __importDefault(require("../../utils/re-executable-promise"));
const runtime_1 = require("../../errors/runtime");
const types_1 = require("../../errors/types");
const lowercase_object_keys_1 = __importDefault(require("../../utils/lowercase-object-keys"));
const DEFAULT_OPTIONS = {
    logRequestHeaders: false,
    logRequestBody: false,
    stringifyRequestBody: false,
    logResponseHeaders: false,
    logResponseBody: false,
    stringifyResponseBody: false,
};
const REQUEST_LOGGER_CLASS_NAME = 'RequestLogger';
class RequestLoggerImplementation extends hook_1.default {
    constructor(requestFilterRuleInit, options) {
        const effectiveOptions = Object.assign({}, DEFAULT_OPTIONS, options);
        RequestLoggerImplementation._assertLogOptions(effectiveOptions);
        const configureResponseEventOptions = new testcafe_hammerhead_1.ConfigureResponseEventOptions(effectiveOptions.logResponseHeaders, effectiveOptions.logResponseBody);
        super(requestFilterRuleInit, configureResponseEventOptions);
        this._className = REQUEST_LOGGER_CLASS_NAME;
        this._options = effectiveOptions;
        this._internalRequests = {};
    }
    static _assertLogOptions(logOptions) {
        if (!logOptions.logRequestBody && logOptions.stringifyRequestBody)
            throw new runtime_1.APIError('RequestLogger', types_1.RUNTIME_ERRORS.requestHookConfigureAPIError, 'RequestLogger', 'Cannot stringify the request body because it is not logged. Specify { logRequestBody: true } in log options.');
        if (!logOptions.logResponseBody && logOptions.stringifyResponseBody)
            throw new runtime_1.APIError('RequestLogger', types_1.RUNTIME_ERRORS.requestHookConfigureAPIError, 'RequestLogger', 'Cannot stringify the response body because it is not logged. Specify { logResponseBody: true } in log options.');
    }
    async onRequest(event) {
        const loggedReq = {
            id: event._requestInfo.requestId,
            testRunId: event._requestInfo.sessionId,
            userAgent: (0, parse_user_agent_1.parseUserAgent)(event._requestInfo.userAgent).prettyUserAgent,
            request: {
                timestamp: Date.now(),
                url: event._requestInfo.url,
                method: event._requestInfo.method,
            },
        };
        if (this._options.logRequestHeaders)
            loggedReq.request.headers = Object.assign({}, (0, lowercase_object_keys_1.default)(event._requestInfo.headers));
        if (this._options.logRequestBody)
            loggedReq.request.body = this._options.stringifyRequestBody ? event._requestInfo.body.toString() : event._requestInfo.body;
        this._internalRequests[loggedReq.id] = loggedReq;
    }
    async onResponse(event) {
        const loggedReq = this._internalRequests[event.requestId];
        // NOTE: If the 'clear' method is called during a long running request,
        // we should not save a response part - request part has been already removed.
        if (!loggedReq)
            return;
        loggedReq.response = {
            statusCode: event.statusCode,
            timestamp: Date.now(),
        };
        if (this._options.logResponseHeaders)
            loggedReq.response.headers = Object.assign({}, event.headers);
        if (this._options.logResponseBody) {
            loggedReq.response.body = this._options.stringifyResponseBody && event.body
                ? event.body.toString()
                : event.body;
        }
    }
    _prepareInternalRequestInfo() {
        const testRun = test_run_tracker_1.default.resolveContextTestRun();
        let preparedRequests = Object.values(this._internalRequests);
        if (testRun)
            preparedRequests = preparedRequests.filter(r => r.testRunId === testRun.id);
        return preparedRequests;
    }
    _getCompletedRequests() {
        return this._prepareInternalRequestInfo().filter(r => r.response);
    }
    // API
    contains(predicate) {
        return re_executable_promise_1.default.fromFn(async () => {
            return !!this._getCompletedRequests().find(predicate);
        });
    }
    count(predicate) {
        return re_executable_promise_1.default.fromFn(async () => {
            return this._getCompletedRequests().filter(predicate).length;
        });
    }
    clear() {
        const testRun = test_run_tracker_1.default.resolveContextTestRun();
        if (testRun) {
            Object.keys(this._internalRequests).forEach(id => {
                if (this._internalRequests[id].testRunId === testRun.id)
                    delete this._internalRequests[id];
            });
        }
        else
            this._internalRequests = {};
    }
    get requests() {
        return this._prepareInternalRequestInfo();
    }
}
function createRequestLogger(requestFilterRuleInit, logOptions) {
    return new RequestLoggerImplementation(requestFilterRuleInit, logOptions);
}
exports.default = createRequestLogger;
module.exports = exports.default;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVxdWVzdC1sb2dnZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvYXBpL3JlcXVlc3QtaG9va3MvcmVxdWVzdC1sb2dnZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSw2REFLNkI7QUFFN0Isa0RBQWlDO0FBQ2pDLG1FQUE4RDtBQUM5RCwyRUFBaUQ7QUFDakQsOEZBQW9FO0FBQ3BFLGtEQUFnRDtBQUNoRCw4Q0FBb0Q7QUFRcEQsOEZBQW9FO0FBR3BFLE1BQU0sZUFBZSxHQUEwQjtJQUMzQyxpQkFBaUIsRUFBTSxLQUFLO0lBQzVCLGNBQWMsRUFBUyxLQUFLO0lBQzVCLG9CQUFvQixFQUFHLEtBQUs7SUFDNUIsa0JBQWtCLEVBQUssS0FBSztJQUM1QixlQUFlLEVBQVEsS0FBSztJQUM1QixxQkFBcUIsRUFBRSxLQUFLO0NBQy9CLENBQUM7QUF5QkYsTUFBTSx5QkFBeUIsR0FBRyxlQUFlLENBQUM7QUFFbEQsTUFBTSwyQkFBNEIsU0FBUSxjQUFXO0lBSWpELFlBQW9CLHFCQUF1RSxFQUFFLE9BQW1DO1FBQzVILE1BQU0sZ0JBQWdCLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxFQUFFLEVBQUUsZUFBZSxFQUFFLE9BQU8sQ0FBMEIsQ0FBQztRQUU5RiwyQkFBMkIsQ0FBQyxpQkFBaUIsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO1FBRWhFLE1BQU0sNkJBQTZCLEdBQUcsSUFBSSxtREFBNkIsQ0FBQyxnQkFBZ0IsQ0FBQyxrQkFBa0IsRUFBRSxnQkFBZ0IsQ0FBQyxlQUFlLENBQUMsQ0FBQztRQUUvSSxLQUFLLENBQUMscUJBQXFCLEVBQUUsNkJBQTZCLENBQUMsQ0FBQztRQUU1RCxJQUFJLENBQUMsVUFBVSxHQUFVLHlCQUF5QixDQUFDO1FBQ25ELElBQUksQ0FBQyxRQUFRLEdBQVksZ0JBQWdCLENBQUM7UUFDMUMsSUFBSSxDQUFDLGlCQUFpQixHQUFHLEVBQUUsQ0FBQztJQUNoQyxDQUFDO0lBRU8s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Q0FBQyxFQUFFO29CQUNuRCxPQUFPLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxFQUFFLENBQUMsQ0FBQztZQUMxQyxDQUFDLENBQUMsQ0FBQztTQUNOOztZQUVHLElBQUksQ0FBQyxpQkFBaUIsR0FBRyxFQUFFLENBQUM7SUFDcEMsQ0FBQztJQUVELElBQVcsUUFBUTtRQUNmLE9BQU8sSUFBSSxDQUFDLDJCQUEyQixFQUFFLENBQUM7SUFDOUMsQ0FBQztDQUNKO0FBRUQsU0FBd0IsbUJBQW1CLENBQUUscUJBQWtGLEVBQUUsVUFBcUM7SUFDbEssT0FBTyxJQUFJLDJCQUEyQixDQUFDLHFCQUFxQixFQUFFLFVBQVUsQ0FBQyxDQUFDO0FBQzlFLENBQUM7QUFGRCxzQ0FFQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gICAgQ29uZmlndXJlUmVzcG9uc2VFdmVudE9wdGlvbnMsXG4gICAgUmVxdWVzdEV2ZW50LFxuICAgIFJlc3BvbnNlRXZlbnQsXG4gICAgUmVxdWVzdEZpbHRlclJ1bGVJbml0LFxufSBmcm9tICd0ZXN0Y2FmZS1oYW1tZXJoZWFkJztcblxuaW1wb3J0IFJlcXVlc3RIb29rIGZyb20gJy4vaG9vayc7XG5pbXBvcnQgeyBwYXJzZVVzZXJBZ2VudCB9IGZyb20gJy4uLy4uL3V0aWxzL3BhcnNlLXVzZXItYWdlbnQnO1xuaW1wb3J0IHRlc3RSdW5UcmFja2VyIGZyb20gJy4uL3Rlc3QtcnVuLXRyYWNrZXInO1xuaW1wb3J0IFJlRXhlY3V0YWJsZVByb21pc2UgZnJvbSAnLi4vLi4vdXRpbHMvcmUtZXhlY3V0YWJsZS1wcm9taXNlJztcbmltcG9ydCB7IEFQSUVycm9yIH0gZnJvbSAnLi4vLi4vZXJyb3JzL3J1bnRpbWUnO1xuaW1wb3J0IHsgUlVOVElNRV9FUlJPUlMgfSBmcm9tICcuLi8uLi9lcnJvcnMvdHlwZXMnO1xuXG5pbXBvcnQge1xuICAgIFJlcXVlc3RIb29rTG9nT3B0aW9uc0luaXQsXG4gICAgUmVxdWVzdEhvb2tMb2dPcHRpb25zLFxufSBmcm9tICcuL2ludGVyZmFjZXMnO1xuXG5pbXBvcnQgeyBEaWN0aW9uYXJ5IH0gZnJvbSAnLi4vLi4vY29uZmlndXJhdGlvbi9pbnRlcmZhY2VzJztcbmltcG9ydCBsb3dlcmNhc2VPYmplY3RLZXlzIGZyb20gJy4uLy4uL3V0aWxzL2xvd2VyY2FzZS1vYmplY3Qta2V5cyc7XG5cblxuY29uc3QgREVGQVVMVF9PUFRJT05TOiBSZXF1ZXN0SG9va0xvZ09wdGlvbnMgPSB7XG4gICAgbG9nUmVxdWVzdEhlYWRlcnM6ICAgICBmYWxzZSxcbiAgICBsb2dSZXF1ZXN0Qm9keTogICAgICAgIGZhbHNlLFxuICAgIHN0cmluZ2lmeVJlcXVlc3RCb2R5OiAgZmFsc2UsXG4gICAgbG9nUmVzcG9uc2VIZWFkZXJzOiAgICBmYWxzZSxcbiAgICBsb2dSZXNwb25zZUJvZHk6ICAgICAgIGZhbHNlLFxuICAgIHN0cmluZ2lmeVJlc3BvbnNlQm9keTogZmFsc2UsXG59O1xuXG5pbnRlcmZhY2UgT3B0aW9uYWxseUxvZ2dlZFBhcnQge1xuICAgIGhlYWRlcnM/OiBhbnk7XG4gICAgYm9keT86IEJ1ZmZlciB8IHN0cmluZztcbn1cblxuaW50ZXJmYWNlIExvZ2dlZFJlcXVlc3RQYXJ0IGV4dGVuZHMgT3B0aW9uYWxseUxvZ2dlZFBhcnQge1xuICAgIHRpbWVzdGFtcDogbnVtYmVyO1xuICAgIHVybDogc3RyaW5nO1xuICAgIG1ldGhvZDogc3RyaW5nO1xufVxuaW50ZXJmYWNlIExvZ2dlZFJlc3BvbnNlUGFydCBleHRlbmRzIE9wdGlvbmFsbHlMb2dnZWRQYXJ0IHtcbiAgICBzdGF0dXNDb2RlOiBudW1iZXI7XG4gICAgdGltZXN0YW1wOiBudW1iZXI7XG59XG5cbmludGVyZmFjZSBMb2dnZWRSZXF1ZXN0IHtcbiAgICBpZDogc3RyaW5nO1xuICAgIHRlc3RSdW5JZDogc3RyaW5nO1xuICAgIHVzZXJBZ2VudDogc3RyaW5nO1xuICAgIHJlcXVlc3Q6IExvZ2dlZFJlcXVlc3RQYXJ0O1xuICAgIHJlc3BvbnNlPzogTG9nZ2VkUmVzcG9uc2VQYXJ0O1xufVxuXG5jb25zdCBSRVFVRVNUX0xPR0dFUl9DTEFTU19OQU1FID0gJ1JlcXVlc3RMb2dnZXInO1xuXG5jbGFzcyBSZXF1ZXN0TG9nZ2VySW1wbGVtZW50YXRpb24gZXh0ZW5kcyBSZXF1ZXN0SG9vayB7XG4gICAgcHJpdmF0ZSByZWFkb25seSBfb3B0aW9uczogUmVxdWVzdEhvb2tMb2dPcHRpb25zO1xuICAgIHByaXZhdGUgX2ludGVybmFsUmVxdWVzdHM6IERpY3Rpb25hcnk8TG9nZ2VkUmVxdWVzdD47XG5cbiAgICBwdWJsaWMgY29uc3RydWN0b3IgKHJlcXVlc3RGaWx0ZXJSdWxlSW5pdD86IFJlcXVlc3RGaWx0ZXJSdWxlSW5pdCB8IFJlcXVlc3RGaWx0ZXJSdWxlSW5pdFtdLCBvcHRpb25zPzogUmVxdWVzdEhvb2tMb2dPcHRpb25zSW5pdCkge1xuICAgICAgICBjb25zdCBlZmZlY3RpdmVPcHRpb25zID0gT2JqZWN0LmFzc2lnbih7fSwgREVGQVVMVF9PUFRJT05TLCBvcHRpb25zKSBhcyBSZXF1ZXN0SG9va0xvZ09wdGlvbnM7XG5cbiAgICAgICAgUmVxdWVzdExvZ2dlckltcGxlbWVudGF0aW9uLl9hc3NlcnRMb2dPcHRpb25zKGVmZmVjdGl2ZU9wdGlvbnMpO1xuXG4gICAgICAgIGNvbnN0IGNvbmZpZ3VyZVJlc3BvbnNlRXZlbnRPcHRpb25zID0gbmV3IENvbmZpZ3VyZVJlc3BvbnNlRXZlbnRPcHRpb25zKGVmZmVjdGl2ZU9wdGlvbnMubG9nUmVzcG9uc2VIZWFkZXJzLCBlZmZlY3RpdmVPcHRpb25zLmxvZ1Jlc3BvbnNlQm9keSk7XG5cbiAgICAgICAgc3VwZXIocmVxdWVzdEZpbHRlclJ1bGVJbml0LCBjb25maWd1cmVSZXNwb25zZUV2ZW50T3B0aW9ucyk7XG5cbiAgICAgICAgdGhpcy5fY2xhc3NOYW1lICAgICAgICA9IFJFUVVFU1RfTE9HR0VSX0NMQVNTX05BTUU7XG4gICAgICAgIHRoaXMuX29wdGlvbnMgICAgICAgICAgPSBlZmZlY3RpdmVPcHRpb25zO1xuICAgICAgICB0aGlzLl9pbnRlcm5hbFJlcXVlc3RzID0ge307XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBzdGF0aWMgX2Fzc2VydExvZ09wdGlvbnMgKGxvZ09wdGlvbnM6IFJlcXVlc3RIb29rTG9nT3B0aW9ucyk6IHZvaWQge1xuICAgICAgICBpZiAoIWxvZ09wdGlvbnMubG9nUmVxdWVzdEJvZHkgJiYgbG9nT3B0aW9ucy5zdHJpbmdpZnlSZXF1ZXN0Qm9keSlcbiAgICAgICAgICAgIHRocm93IG5ldyBBUElFcnJvcignUmVxdWVzdExvZ2dlcicsIFJVTlRJTUVfRVJST1JTLnJlcXVlc3RIb29rQ29uZmlndXJlQVBJRXJyb3IsICdSZXF1ZXN0TG9nZ2VyJywgJ0Nhbm5vdCBzdHJpbmdpZnkgdGhlIHJlcXVlc3QgYm9keSBiZWNhdXNlIGl0IGlzIG5vdCBsb2dnZWQuIFNwZWNpZnkgeyBsb2dSZXF1ZXN0Qm9keTogdHJ1ZSB9IGluIGxvZyBvcHRpb25zLicpO1xuXG4gICAgICAgIGlmICghbG9nT3B0aW9ucy5sb2dSZXNwb25zZUJvZHkgJiYgbG9nT3B0aW9ucy5zdHJpbmdpZnlSZXNwb25zZUJvZHkpXG4gICAgICAgICAgICB0aHJvdyBuZXcgQVBJRXJyb3IoJ1JlcXVlc3RMb2dnZXInLCBSVU5USU1FX0VSUk9SUy5yZXF1ZXN0SG9va0NvbmZpZ3VyZUFQSUVycm9yLCAnUmVxdWVzdExvZ2dlcicsICdDYW5ub3Qgc3RyaW5naWZ5IHRoZSByZXNwb25zZSBib2R5IGJlY2F1c2UgaXQgaXMgbm90IGxvZ2dlZC4gU3BlY2lmeSB7IGxvZ1Jlc3BvbnNlQm9keTogdHJ1ZSB9IGluIGxvZyBvcHRpb25zLicpO1xuICAgIH1cblxuICAgIHB1YmxpYyBhc3luYyBvblJlcXVlc3QgKGV2ZW50OiBSZXF1ZXN0RXZlbnQpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgY29uc3QgbG9nZ2VkUmVxOiBMb2dnZWRSZXF1ZXN0ID0ge1xuICAgICAgICAgICAgaWQ6ICAgICAgICBldmVudC5fcmVxdWVzdEluZm8ucmVxdWVzdElkLFxuICAgICAgICAgICAgdGVzdFJ1bklkOiBldmVudC5fcmVxdWVzdEluZm8uc2Vzc2lvbklkLFxuICAgICAgICAgICAgdXNlckFnZW50OiBwYXJzZVVzZXJBZ2VudChldmVudC5fcmVxdWVzdEluZm8udXNlckFnZW50KS5wcmV0dHlVc2VyQWdlbnQsXG4gICAgICAgICAgICByZXF1ZXN0OiAgIHtcbiAgICAgICAgICAgICAgICB0aW1lc3RhbXA6IERhdGUubm93KCksXG4gICAgICAgICAgICAgICAgdXJsOiAgICAgICBldmVudC5fcmVxdWVzdEluZm8udXJsLFxuICAgICAgICAgICAgICAgIG1ldGhvZDogICAgZXZlbnQuX3JlcXVlc3RJbmZvLm1ldGhvZCxcbiAgICAgICAgICAgIH0sXG4gICAgICAgIH07XG5cbiAgICAgICAgaWYgKHRoaXMuX29wdGlvbnMubG9nUmVxdWVzdEhlYWRlcnMpXG4gICAgICAgICAgICBsb2dnZWRSZXEucmVxdWVzdC5oZWFkZXJzID0gT2JqZWN0LmFzc2lnbih7fSwgbG93ZXJjYXNlT2JqZWN0S2V5cyhldmVudC5fcmVxdWVzdEluZm8uaGVhZGVycyBhcyBEaWN0aW9uYXJ5PHN0cmluZz4pKTtcblxuICAgICAgICBpZiAodGhpcy5fb3B0aW9ucy5sb2dSZXF1ZXN0Qm9keSlcbiAgICAgICAgICAgIGxvZ2dlZFJlcS5yZXF1ZXN0LmJvZHkgPSB0aGlzLl9vcHRpb25zLnN0cmluZ2lmeVJlcXVlc3RCb2R5ID8gZXZlbnQuX3JlcXVlc3RJbmZvLmJvZHkudG9TdHJpbmcoKSA6IGV2ZW50Ll9yZXF1ZXN0SW5mby5ib2R5O1xuXG4gICAgICAgIHRoaXMuX2ludGVybmFsUmVxdWVzdHNbbG9nZ2VkUmVxLmlkXSA9IGxvZ2dlZFJlcTtcbiAgICB9XG5cbiAgICBwdWJsaWMgYXN5bmMgb25SZXNwb25zZSAoZXZlbnQ6IFJlc3BvbnNlRXZlbnQpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgY29uc3QgbG9nZ2VkUmVxID0gdGhpcy5faW50ZXJuYWxSZXF1ZXN0c1tldmVudC5yZXF1ZXN0SWRdO1xuXG4gICAgICAgIC8vIE5PVEU6IElmIHRoZSAnY2xlYXInIG1ldGhvZCBpcyBjYWxsZWQgZHVyaW5nIGEgbG9uZyBydW5uaW5nIHJlcXVlc3QsXG4gICAgICAgIC8vIHdlIHNob3VsZCBub3Qgc2F2ZSBhIHJlc3BvbnNlIHBhcnQgLSByZXF1ZXN0IHBhcnQgaGFzIGJlZW4gYWxyZWFkeSByZW1vdmVkLlxuICAgICAgICBpZiAoIWxvZ2dlZFJlcSlcbiAgICAgICAgICAgIHJldHVybjtcblxuICAgICAgICBsb2dnZWRSZXEucmVzcG9uc2UgPSB7XG4gICAgICAgICAgICBzdGF0dXNDb2RlOiBldmVudC5zdGF0dXNDb2RlLFxuICAgICAgICAgICAgdGltZXN0YW1wOiAgRGF0ZS5ub3coKSxcbiAgICAgICAgfTtcblxuICAgICAgICBpZiAodGhpcy5fb3B0aW9ucy5sb2dSZXNwb25zZUhlYWRlcnMpXG4gICAgICAgICAgICBsb2dnZWRSZXEucmVzcG9uc2UuaGVhZGVycyA9IE9iamVjdC5hc3NpZ24oe30sIGV2ZW50LmhlYWRlcnMpO1xuXG4gICAgICAgIGlmICh0aGlzLl9vcHRpb25zLmxvZ1Jlc3BvbnNlQm9keSkge1xuICAgICAgICAgICAgbG9nZ2VkUmVxLnJlc3BvbnNlLmJvZHkgPSB0aGlzLl9vcHRpb25zLnN0cmluZ2lmeVJlc3BvbnNlQm9keSAmJiBldmVudC5ib2R5XG4gICAgICAgICAgICAgICAgPyBldmVudC5ib2R5LnRvU3RyaW5nKClcbiAgICAgICAgICAgICAgICA6IGV2ZW50LmJvZHk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIF9wcmVwYXJlSW50ZXJuYWxSZXF1ZXN0SW5mbyAoKTogTG9nZ2VkUmVxdWVzdFtdIHtcbiAgICAgICAgY29uc3QgdGVzdFJ1biAgICAgICAgPSB0ZXN0UnVuVHJhY2tlci5yZXNvbHZlQ29udGV4dFRlc3RSdW4oKTtcbiAgICAgICAgbGV0IHByZXBhcmVkUmVxdWVzdHMgPSBPYmplY3QudmFsdWVzKHRoaXMuX2ludGVybmFsUmVxdWVzdHMpO1xuXG4gICAgICAgIGlmICh0ZXN0UnVuKVxuICAgICAgICAgICAgcHJlcGFyZWRSZXF1ZXN0cyA9IHByZXBhcmVkUmVxdWVzdHMuZmlsdGVyKHIgPT4gci50ZXN0UnVuSWQgPT09IHRlc3RSdW4uaWQpO1xuXG4gICAgICAgIHJldHVybiBwcmVwYXJlZFJlcXVlc3RzO1xuICAgIH1cblxuICAgIHByaXZhdGUgX2dldENvbXBsZXRlZFJlcXVlc3RzICgpOiBMb2dnZWRSZXF1ZXN0W10ge1xuICAgICAgICByZXR1cm4gdGhpcy5fcHJlcGFyZUludGVybmFsUmVxdWVzdEluZm8oKS5maWx0ZXIociA9PiByLnJlc3BvbnNlKTtcbiAgICB9XG5cbiAgICAvLyBBUElcbiAgICBwdWJsaWMgY29udGFpbnMgKHByZWRpY2F0ZTogKHJlcXVlc3Q6IExvZ2dlZFJlcXVlc3QpID0+IGJvb2xlYW4pOiBSZUV4ZWN1dGFibGVQcm9taXNlIHtcbiAgICAgICAgcmV0dXJuIFJlRXhlY3V0YWJsZVByb21pc2UuZnJvbUZuKGFzeW5jICgpID0+IHtcbiAgICAgICAgICAgIHJldHVybiAhIXRoaXMuX2dldENvbXBsZXRlZFJlcXVlc3RzKCkuZmluZChwcmVkaWNhdGUpO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwdWJsaWMgY291bnQgKHByZWRpY2F0ZTogKHJlcXVlc3Q6IExvZ2dlZFJlcXVlc3QpID0+IGJvb2xlYW4pOiBSZUV4ZWN1dGFibGVQcm9taXNlIHtcbiAgICAgICAgcmV0dXJuIFJlRXhlY3V0YWJsZVByb21pc2UuZnJvbUZuKGFzeW5jICgpID0+IHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLl9nZXRDb21wbGV0ZWRSZXF1ZXN0cygpLmZpbHRlcihwcmVkaWNhdGUpLmxlbmd0aDtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHVibGljIGNsZWFyICgpOiB2b2lkIHtcbiAgICAgICAgY29uc3QgdGVzdFJ1biA9IHRlc3RSdW5UcmFja2VyLnJlc29sdmVDb250ZXh0VGVzdFJ1bigpO1xuXG4gICAgICAgIGlmICh0ZXN0UnVuKSB7XG4gICAgICAgICAgICBPYmplY3Qua2V5cyh0aGlzLl9pbnRlcm5hbFJlcXVlc3RzKS5mb3JFYWNoKGlkID0+IHtcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5faW50ZXJuYWxSZXF1ZXN0c1tpZF0udGVzdFJ1bklkID09PSB0ZXN0UnVuLmlkKVxuICAgICAgICAgICAgICAgICAgICBkZWxldGUgdGhpcy5faW50ZXJuYWxSZXF1ZXN0c1tpZF07XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlXG4gICAgICAgICAgICB0aGlzLl9pbnRlcm5hbFJlcXVlc3RzID0ge307XG4gICAgfVxuXG4gICAgcHVibGljIGdldCByZXF1ZXN0cyAoKTogTG9nZ2VkUmVxdWVzdFtdIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX3ByZXBhcmVJbnRlcm5hbFJlcXVlc3RJbmZvKCk7XG4gICAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBmdW5jdGlvbiBjcmVhdGVSZXF1ZXN0TG9nZ2VyIChyZXF1ZXN0RmlsdGVyUnVsZUluaXQ6IFJlcXVlc3RGaWx0ZXJSdWxlSW5pdCB8IFJlcXVlc3RGaWx0ZXJSdWxlSW5pdFtdIHwgdW5kZWZpbmVkLCBsb2dPcHRpb25zOiBSZXF1ZXN0SG9va0xvZ09wdGlvbnNJbml0KTogUmVxdWVzdExvZ2dlckltcGxlbWVudGF0aW9uIHtcbiAgICByZXR1cm4gbmV3IFJlcXVlc3RMb2dnZXJJbXBsZW1lbnRhdGlvbihyZXF1ZXN0RmlsdGVyUnVsZUluaXQsIGxvZ09wdGlvbnMpO1xufVxuIl19